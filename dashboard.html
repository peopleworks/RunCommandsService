<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{TITLE}}</title>
    <style>
        :root {
            --bg: #0b1220;
            --card: #0f172a;
            --muted: #9aa4b2;
            --fg: #e6edf3;
            --line: #1e293b;
            --ok: #10b981;
            --warn: #f59e0b;
            --err: #ef4444;
            --chip: #111827;
            --brand1: #7c3aed;
            --brand2: #06b6d4;
            --shadow: 0 8px 30px rgba(2,6,23,.35);
        }

        @media (prefers-color-scheme: light) {
            :root {
                --bg: #f6f8fc;
                --card: #fff;
                --muted: #6b7280;
                --fg: #0f172a;
                --line: #e5e7eb;
                --chip: #eef2ff;
                --shadow: 0 8px 24px rgba(15,23,42,.08);
            }
        }

        * {
            box-sizing: border-box
        }

        html, body {
            height: 100%
        }

        body {
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
            margin: 0;
            background: radial-gradient(1200px 800px at 10% -10%, var(--brand1) 0%, transparent 40%), radial-gradient(1000px 600px at 120% 0%, transparent 35%), var(--bg);
            color: var(--fg);
        }

        header {
            position: sticky;
            top: 0;
            z-index: 5;
            padding: 18px 16px;
            background: linear-gradient(0deg, rgba(2,6,23,.6), rgba(2,6,23,.6));
            backdrop-filter: saturate(180%) blur(8px);
            border-bottom: 1px solid rgba(255,255,255,.06);
        }

        .title {
            margin: 0;
            font-weight: 700;
            letter-spacing: .2px;
            font-size: 20px
        }

        .subtitle {
            font-size: 13px;
            color: var(--muted)
        }

        .wrap {
            padding: 18px 16px;
            width: 100%;
            max-width: 100vw;
            margin: 0;
        }

        .toolbar {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            margin: 12px 0 18px
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--card);
            border: 1px solid var(--line);
            color: var(--fg);
            padding: 8px 10px;
            border-radius: 999px;
            box-shadow: var(--shadow);
            font-size: 12px
        }

        .toolbar input[type="text"] {
            background: var(--card);
            border: 1px solid var(--line);
            color: var(--fg);
            padding: 10px 12px;
            border-radius: 10px;
            outline: none;
            min-width: 240px;
            box-shadow: var(--shadow)
        }

        .kpi {
            display: grid;
            grid-template-columns: repeat(4,minmax(220px,1fr));
            gap: 12px;
            margin: 0 0 16px
        }

            .kpi .item {
                background: var(--card);
                border: 1px solid var(--line);
                border-radius: 14px;
                padding: 12px 14px;
                box-shadow: var(--shadow)
            }

            .kpi .v {
                font-size: 20px;
                font-weight: 700
            }

        .grid {
            display: grid;
            gap: 18px;
            grid-template-columns: 1fr
        }

        @media(min-width:1100px) {
            .grid {
                grid-template-columns: 1.25fr .75fr
            }
        }

        .card {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: 16px;
            box-shadow: var(--shadow)
        }

            .card h3 {
                margin: 0;
                padding: 14px 16px;
                border-bottom: 1px solid var(--line);
                font-size: 14px;
                letter-spacing: .2px
            }

            .card .body {
                padding: 8px 12px
            }

        .table-wrap {
            overflow: auto;
            max-height: 45vh
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            white-space: nowrap
        }

        thead th {
            position: sticky;
            top: 0;
            background: var(--card);
            z-index: 1;
            text-align: left;
            color: var(--muted);
            padding: 10px 8px;
            font-weight: 600;
            border-bottom: 1px solid var(--line)
        }

        tbody td {
            padding: 10px 8px;
            border-bottom: 1px dashed var(--line)
        }

        tbody tr:hover {
            background: rgba(255,255,255,.03)
        }

        .mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            background: var(--chip);
            border: 1px solid var(--line)
        }

        .ok {
            color: var(--ok)
        }

        .warn {
            color: var(--warn)
        }

        .err {
            color: var(--err)
        }

        .muted {
            color: var(--muted)
        }

        .box {
            padding: 12px;
            border-radius: 12px;
            overflow: auto;
            max-height: 40vh;
            background: var(--card);
            border: 1px solid var(--line)
        }

        .logbox {
            white-space: pre;
            font-size: 12px
        }

        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(2,6,23,.55);
            z-index: 50
        }

            .modal.open {
                display: flex
            }

        .sheet {
            width: min(920px,96vw);
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: 16px;
            box-shadow: var(--shadow);
            padding: 16px
        }

            .sheet h3 {
                margin: 0 0 12px
            }

        .grid2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px
        }

        .grid1 {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 6px
        }

            .field input, .field textarea, .field select {
                background: var(--card);
                color: var(--fg);
                border: 1px solid var(--line);
                border-radius: 10px;
                padding: 10px
            }

        .actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 12px
        }

        .btn {
            background: var(--brand1);
            color: #fff;
            border: 0;
            border-radius: 10px;
            padding: 10px 14px;
            cursor: pointer
        }

            .btn.secondary {
                background: transparent;
                border: 1px solid var(--line);
                color: var(--fg)
            }
    </style>
</head>
<body>
    <header class="wrap">
        <h1 class="title">{{TITLE}}</h1>
        <div class="subtitle">Beautiful, fast, and shareable monitoring for scheduled jobs.</div>
    </header>

    <div class="wrap">
        <div class="toolbar">
            <span class="pill">Auto-refresh: every <strong class="mono" id="autoSz">{{AUTO_REFRESH_SECONDS}}s</strong></span>
            {{RAW_TOGGLE}}
            <label class="pill"><input id="pause" type="checkbox"> Pause</label>
            <input id="search" type="text" placeholder="Filter jobs by id / key / cron…" />
            <button id="btnNew" class="pill">+ New job</button>
            <span id="status" class="muted"></span>
        </div>

        <!-- KPI cards -->
        <div class="kpi" id="kpis">
            <div class="item"><div class="muted">Events</div><div class="v" id="k_total">0</div></div>
            <div class="item"><div class="muted">OK</div><div class="v ok" id="k_ok">0</div></div>
            <div class="item"><div class="muted">Failed</div><div class="v err" id="k_fail">0</div></div>
            <div class="item"><div class="muted">Avg Duration</div><div class="v" id="k_avg">—</div></div>
        </div>

        <div class="grid">
            <div class="card">
                <h3>Scheduled Jobs</h3>
                <div class="body">
                    <div class="table-wrap">
                        <table id="tblJobs">
                            <thead>
                                <tr>
                                    <th>Id</th>
                                    <th>Cron</th>
                                    <th>TZ</th>
                                    <th>Key</th>
                                    <th>Parallel</th>
                                    <th>Max (min)</th>
                                    <th>Next run</th>
                                    <th>Enabled</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>Recent Executions</h3>
                <div class="body">
                    <div class="table-wrap">
                        <table id="tblExec">
                            <thead>
                                <tr>
                                    <th>When (UTC)</th>
                                    <th>Id</th>
                                    <th>Exit</th>
                                    <th>Duration</th>
                                    <th>Status</th>
                                    <th>Error</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div style="margin-top:18px">
            <div class="card">
                <h3>Service Logs (tail)</h3>
                <div class="body">
                    <div class="toolbar" style="margin:0 0 8px">
                        <label class="pill"><input id="follow" type="checkbox" checked> Follow</label>
                        <label class="pill">
                            Tail
                            <select id="tailKb"><option>64</option><option selected>128</option><option>256</option><option>512</option><option>1024</option></select> KB
                        </label>
                        <button class="pill" id="copyLogs">Copy</button>
                    </div>
                    <pre id="logs" class="box logbox mono"></pre>
                </div>
            </div>
        </div>

        <details id="raw" style="margin-top:18px;">
            <summary>Raw JSON</summary>
            <pre class="box mono" id="json"></pre>
        </details>
    </div>

    <!-- JOB BUILDER MODAL -->
    <div id="jobModal" class="modal" aria-hidden="true">
        <div class="sheet">
            <h3>Create job</h3>
            <div class="grid2">
                <div class="field">
                    <label>Id</label>
                    <input id="j_id" placeholder="unique-id">
                </div>
                <div class="field">
                    <label>Time zone</label>
                    <input id="j_tz" placeholder="Eastern Standard Time">
                </div>
                <div class="field" style="grid-column:1 / -1">
                    <label>Command</label>
                    <textarea id="j_cmd" rows="3" class="mono" placeholder='cmd /c "pushd C:\\Apps\\MyJob && \"C:\\Program Files\\nodejs\\node.exe\" app.js"'></textarea>
                </div>

                <div class="field">
                    <label>Concurrency key (optional)</label>
                    <input id="j_key" placeholder="my-key">
                </div>
                <div class="field">
                    <label>Max runtime (minutes)</label>
                    <input id="j_mrm" type="number" placeholder="60">
                </div>

                <div class="field">
                    <label><input type="checkbox" id="j_parallel"> Allow parallel runs</label>
                    <label><input type="checkbox" id="j_cap" checked> CaptureOutput</label>
                </div>
                <div class="field">
                    <label><input type="checkbox" id="j_quiet"> QuietStartLog</label>
                    <label><input type="checkbox" id="j_alert" checked> AlertOnFail</label>
                </div>

                <div class="field" style="grid-column:1 / -1">
                    <label>Custom alert message</label>
                    <input id="j_msg" placeholder="Human hint to include in alert emails">
                </div>

                <div class="field" style="grid-column:1 / -1">
                    <label>Cron expression</label>
                    <div class="grid1">
                        <input id="cronTxt" class="mono" placeholder="*/5 * * * *">
                        <div class="actions" style="justify-content:flex-start">
                            <button id="cronPrevBtn" class="btn secondary">Preview next 5</button>
                            <div id="cronNext" class="mono" style="margin-left:10px; white-space:pre-wrap"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="actions">
                <button id="closeJob" class="btn secondary">Cancel</button>
                <button id="saveJob" class="btn">Save</button>
            </div>
        </div>
    </div>

    <script>
const autoSeconds = parseInt('{{AUTO_REFRESH_SECONDS}}', 10) || 5;
let timer=null, logTimer=null;

function fmtMs(ms){ if(ms==null) return '—'; if(ms<1000) return ms+' ms';
  const s=ms/1000; if(s<60) return s.toFixed(1)+' s'; const m=Math.floor(s/60), r=Math.round(s%60); return m+'m '+r+'s'; }
function p(o, lc, pc){ return o && (o[lc]!==undefined ? o[lc] : o[pc]); }

function startTimer(){ stopTimer();
  timer=setInterval(()=>{ if(!document.getElementById('pause').checked) load(); }, autoSeconds*1000);
  logTimer=setInterval(()=>{ if(!document.getElementById('pause').checked) loadLogs(); }, autoSeconds*1000);}
function stopTimer(){ if(timer){clearInterval(timer);timer=null;} if(logTimer){clearInterval(logTimer);logTimer=null;}}

document.getElementById('pause').addEventListener('change', e => { e.target.checked ? stopTimer() : startTimer(); });
document.getElementById('search').addEventListener('input', () => load());
document.getElementById('copyLogs').addEventListener('click', async () => {
  try{ await navigator.clipboard.writeText(document.getElementById('logs').textContent); }catch{}
});

async function load(){
  try{
    const r = await fetch('/api/health', {cache:'no-store'}); const d = await r.json();
    const now = new Date(p(d,'nowUtc','NowUtc')); document.getElementById('status').textContent = `Now: ${now.toISOString()}  |  events: ${p(d,'recentCount','RecentCount')}`;

    const jobs = (d.scheduled || d.Scheduled || []); const exec = (d.recent || d.Recent || []);
    const total = exec.length, ok = exec.filter(ev => !!p(ev,'success','Success')).length,
          fail = exec.filter(ev => !p(ev,'success','Success') && !p(ev,'skippedDueToConflict','SkippedDueToConflict')).length;
    const avg = total ? Math.round(exec.reduce((s,ev)=>s+(Number(p(ev,'durationMs','DurationMs'))||0),0)/total) : null;
    document.getElementById('k_total').textContent = total; document.getElementById('k_ok').textContent = ok;
    document.getElementById('k_fail').textContent = fail; document.getElementById('k_avg').textContent = avg?fmtMs(avg):'—';

    const q = document.getElementById('search').value.toLowerCase();
    const jb = document.querySelector('#tblJobs tbody'); jb.innerHTML = '';

    jobs.filter(j => !q || (p(j,'id','Id')||'').toLowerCase().includes(q) ||
                           (p(j,'concurrencyKey','ConcurrencyKey')||'').toLowerCase().includes(q) ||
                           (p(j,'cronExpression','CronExpression')||'').toLowerCase().includes(q))
        .forEach(j => {
            const tr = document.createElement('tr');
            const nextLocal = p(j, 'nextRunLocal', 'NextRunLocal');
            const nextUtc = p(j, 'nextRunUtc', 'NextRunUtc');

          tr.innerHTML = `<td class="mono">${p(j,'id','Id')}</td>
            <td class="mono">${p(j,'cronExpression','CronExpression')}</td>
            <td>${p(j,'timeZone','TimeZone')}</td>
            <td class="mono">${p(j,'concurrencyKey','ConcurrencyKey')||''}</td>
            <td>${p(j,'allowParallelRuns','AllowParallelRuns')?'Yes':'No'}</td>
            <td>${p(j,'maxRuntimeMinutes','MaxRuntimeMinutes')??''}</td>
            <td class="mono">${nextLocal || nextUtc || ''}</td>
            <td>${p(j,'enabled','Enabled')?'<span class="chip">ON</span>':'<span class="chip">OFF</span>'}</td>`;
          jb.appendChild(tr);
        });

    const eb = document.querySelector('#tblExec tbody'); eb.innerHTML='';
    exec.sort((a,b)=> (Date.parse(p(b,'endUtc','EndUtc')||0)||0) - (Date.parse(p(a,'endUtc','EndUtc')||0)||0))
        .forEach(ev=>{
          const ok = !!p(ev,'success','Success'); const sk = !!p(ev,'skippedDueToConflict','SkippedDueToConflict');
          const status = sk?'<span class="warn">Skipped (lock)</span>':(ok?'<span class="ok">OK</span>':'<span class="err">FAIL</span>');
          const tr=document.createElement('tr');
          tr.innerHTML = `<td class="mono">${p(ev,'endUtc','EndUtc')||''}</td>
            <td class="mono">${p(ev,'commandId','CommandId')||''}</td>
            <td>${p(ev,'exitCode','ExitCode')??''}</td>
            <td>${fmtMs(p(ev,'durationMs','DurationMs'))}</td>
            <td>${status}</td>
            <td class="mono">${(p(ev,'error','Error')||'').slice(0,300)}</td>`;
          eb.appendChild(tr);
        });

    const toggle = document.getElementById('toggleRaw');
    const pre = document.getElementById('json'); const details = document.getElementById('raw');
    if (toggle && pre && details) { if (toggle.checked) { pre.textContent = JSON.stringify(d, null, 2); details.open = true; } else { pre.textContent = ''; details.open = false; } }
  }catch{ document.getElementById('status').textContent = 'Error loading /api/health'; }
}

async function loadLogs(){
  try{
    const kb=document.getElementById('tailKb').value||'128';
    const r=await fetch(`/api/logs?tailKb=${encodeURIComponent(kb)}`,{cache:'no-store'}); const el=document.getElementById('logs');
    if(!r.ok){ el.textContent='(no logs found)'; return; }
    const t=await r.text(); const follow=document.getElementById('follow').checked;
    const atBottom=(el.scrollTop+el.clientHeight+50)>=el.scrollHeight; el.textContent=t||'(empty)';
    if(follow||atBottom){ el.scrollTop=el.scrollHeight; }
  }catch{ document.getElementById('logs').textContent='(error reading logs)'; }
}

load(); loadLogs(); startTimer();

// ===== Job Builder modal =====
const modal = document.getElementById('jobModal');
document.getElementById('btnNew').onclick = () => { modal.classList.add('open'); };
document.getElementById('closeJob').onclick = () => { modal.classList.remove('open'); };

document.getElementById('cronPrevBtn').onclick = async () => {
  const cron = document.getElementById('cronTxt').value.trim();
  const tz = document.getElementById('j_tz').value.trim();
  const r = await fetch('/api/jobs/validateCron', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ cron, timeZone: tz })});
  const d = await r.json();
  document.getElementById('cronNext').textContent = d.ok ? (d.next||[]).join('\n') : ('Invalid: ' + d.error);
};

document.getElementById('saveJob').onclick = async () => {
  const job = {
    Id: document.getElementById('j_id').value.trim(),
    Command: document.getElementById('j_cmd').value,
    CronExpression: document.getElementById('cronTxt').value.trim(),
    TimeZone: document.getElementById('j_tz').value.trim() || "UTC",
    Enabled: true,
    AllowParallelRuns: document.getElementById('j_parallel').checked,
    ConcurrencyKey: document.getElementById('j_key').value.trim() || null,
    MaxRuntimeMinutes: parseInt(document.getElementById('j_mrm').value||"0") || null,
    AlertOnFail: document.getElementById('j_alert').checked,
    CaptureOutput: document.getElementById('j_cap').checked,
    QuietStartLog: document.getElementById('j_quiet').checked,
    CustomAlertMessage: document.getElementById('j_msg').value || null
  };

  if(!job.Id || !job.Command || !job.CronExpression){ alert('Id, Command, Cron are required'); return; }

  // simple admin key prompt (stored locally for convenience)
  let key = localStorage.getItem('adminKey');
  if(!key){ key = prompt('Admin Key'); if(!key) return; localStorage.setItem('adminKey', key); }

  const r = await fetch('/api/jobs', {
    method:'POST',
    headers:{'Content-Type':'application/json','X-Admin-Key':key},
    body: JSON.stringify(job)
  });

  if(r.ok){ modal.classList.remove('open'); load(); alert('Job created'); }
  else { const t = await r.text(); alert('Save failed: '+t); }
};
    </script>
</body>
</html>
