<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{TITLE}}</title>
    <style>
        :root {
            --bg: #0b1220;
            --card: #0f172a;
            --muted: #9aa4b2;
            --fg: #e6edf3;
            --line: #1e293b;
            --ok: #10b981;
            --warn: #f59e0b;
            --err: #ef4444;
            --chip: #111827;
            --brand1: #7c3aed;
            --brand2: #06b6d4;
            --shadow: 0 8px 30px rgba(2,6,23,.35);
        }

        @media (prefers-color-scheme: light) {
            :root {
                --bg: #f6f8fc;
                --card: #ffffff;
                --muted: #6b7280;
                --fg: #0f172a;
                --line: #e5e7eb;
                --shadow: 0 8px 24px rgba(15,23,42,.08);
                --chip: #eef2ff;
            }
        }

        * {
            box-sizing: border-box
        }

        html, body {
            height: 100%
        }

        body {
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
            margin: 0;
            background: radial-gradient(1200px 800px at 10% -10%, var(--brand1) 0%, transparent 40%), radial-gradient(1000px 600px at 120% 0%, var(--brand2) 0%, transparent 35%), var(--bg);
            color: var(--fg);
        }

        header {
            position: sticky;
            top: 0;
            z-index: 5;
            padding: 18px 22px;
            background: linear-gradient(0deg, rgba(2,6,23,.6), rgba(2,6,23,.6)), transparent;
            backdrop-filter: saturate(180%) blur(8px);
            border-bottom: 1px solid rgba(255,255,255,.06);
        }

        .title {
            margin: 0;
            font-weight: 700;
            letter-spacing: .2px;
            font-size: 20px;
        }

        .subtitle {
            font-size: 13px;
            color: var(--muted)
        }

        .wrap {
            padding: 22px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .toolbar {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            margin: 12px 0 18px;
        }

            .toolbar .pill {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                background: var(--card);
                border: 1px solid var(--line);
                color: var(--fg);
                padding: 8px 10px;
                border-radius: 999px;
                box-shadow: var(--shadow);
                font-size: 12px;
            }

            .toolbar input[type="text"] {
                background: var(--card);
                border: 1px solid var(--line);
                color: var(--fg);
                padding: 10px 12px;
                border-radius: 10px;
                outline: none;
                min-width: 220px;
                box-shadow: var(--shadow);
            }

        .grid {
            display: grid;
            gap: 18px;
            grid-template-columns: 1fr;
        }

        @media(min-width:1000px) {
            .grid {
                grid-template-columns: 1.2fr .8fr;
            }
        }

        .card {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: 16px;
            box-shadow: var(--shadow);
        }

            .card h3 {
                margin: 0;
                padding: 14px 16px;
                border-bottom: 1px solid var(--line);
                font-size: 14px;
                letter-spacing: .2px
            }

            .card .body {
                padding: 8px 12px
            }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px
        }

        thead th {
            text-align: left;
            color: var(--muted);
            padding: 10px 8px;
            font-weight: 600;
            border-bottom: 1px solid var(--line);
            cursor: default
        }

        tbody td {
            padding: 10px 8px;
            border-bottom: 1px dashed var(--line)
        }

        tbody tr:hover {
            background: rgba(255,255,255,.03)
        }

        .mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            background: var(--chip);
            border: 1px solid var(--line)
        }

        .ok {
            color: var(--ok)
        }

        .warn {
            color: var(--warn)
        }

        .err {
            color: var(--err)
        }

        details {
            margin-top: 18px
        }

        summary {
            cursor: pointer;
            color: var(--muted)
        }

        .kpi {
            display: grid;
            grid-template-columns: repeat(4,1fr);
            gap: 12px;
            margin-bottom: 14px
        }

            .kpi .item {
                background: var(--card);
                border: 1px solid var(--line);
                border-radius: 14px;
                padding: 12px 14px;
                box-shadow: var(--shadow);
            }

                .kpi .item .v {
                    font-size: 20px;
                    font-weight: 700
                }

        .muted {
            color: var(--muted)
        }

        .btnlink {
            background: none;
            border: none;
            color: var(--fg);
            text-decoration: underline;
            cursor: pointer;
            font-size: 12px
        }

        .sortable {
            cursor: pointer
        }
    </style>
</head>
<body>
    <header class="wrap">
        <h1 class="title">{{TITLE}}</h1>
        <div class="subtitle">Beautiful, fast, and shareable monitoring for scheduled jobs.</div>
    </header>

    <div class="wrap">
        <div class="toolbar">
            <span class="pill">Auto‑refresh: every <strong class="mono" id="autoSz">{{AUTO_REFRESH_SECONDS}}s</strong></span>
            {{RAW_TOGGLE}}
            <label class="pill"><input id="pause" type="checkbox"> Pause</label>
            <input id="search" type="text" placeholder="Filter jobs by id / key / cron…" />
            <span id="status" class="muted"></span>
        </div>

        <div class="kpi" id="kpis">
            <div class="item"><div class="muted">Events</div><div class="v" id="k_total">0</div></div>
            <div class="item"><div class="muted">OK</div><div class="v ok" id="k_ok">0</div></div>
            <div class="item"><div class="muted">Failed</div><div class="v err" id="k_fail">0</div></div>
            <div class="item"><div class="muted">Avg Duration</div><div class="v" id="k_avg">—</div></div>
        </div>

        <div class="grid">
            <div class="card">
                <h3>Scheduled Jobs</h3>
                <div class="body">
                    <table id="tblJobs">
                        <thead>
                            <tr>
                                <th class="sortable" data-field="id">Id</th>
                                <th>Cron</th>
                                <th>TZ</th>
                                <th>Key</th>
                                <th>Parallel</th>
                                <th>Max (min)</th>
                                <th class="sortable" data-field="nextRunUtc">Next run (UTC)</th>
                                <th>Enabled</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h3>Recent Executions</h3>
                <div class="body">
                    <table id="tblExec">
                        <thead>
                            <tr>
                                <th class="sortable" data-field="endUtc">When (UTC)</th>
                                <th class="sortable" data-field="commandId">Id</th>
                                <th>Exit</th>
                                <th class="sortable" data-field="durationMs">Duration</th>
                                <th>Status</th>
                                <th>Error</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <details id="raw" style="margin-top:18px;">
            <summary>Raw JSON</summary>
            <pre class="card mono" style="padding:12px; border-radius:12px; overflow:auto" id="json"></pre>
        </details>
    </div>

    <script>
const p = (o, lc, pc) => (o && (o[lc] !== undefined ? o[lc] : o[pc]));
const autoSeconds = parseInt('{{AUTO_REFRESH_SECONDS}}', 10) || 5;
let timer = null;
let sortExec = { field: 'endUtc', dir: 'desc' };
let sortJobs = { field: 'id', dir: 'asc' };

function fmtMs(ms){
  if(ms == null) return '—';
  if(ms < 1000) return ms + ' ms';
  const s = ms/1000;
  if(s < 60) return s.toFixed(1) + ' s';
  const m = Math.floor(s/60), r = Math.round(s%60);
  return m + 'm ' + r + 's';
}

function computeKpis(recent){
  const total = recent.length;
  let ok=0, fail=0, skip=0, sum=0;
  recent.forEach(ev => {
    const s = !!p(ev,'success','Success');
    const sk = !!p(ev,'skippedDueToConflict','SkippedDueToConflict');
    if(sk) skip++;
    else if(s) ok++;
    else fail++;
    const d = p(ev,'durationMs','DurationMs'); if(typeof d === 'number') sum += d;
  });
  const avg = total ? Math.round(sum/total) : null;
  return { total, ok, fail, skip, avg };
}

function startTimer(){
  stopTimer();
  timer = setInterval(() => { if(!document.getElementById('pause').checked) load(); }, autoSeconds*1000);
}
function stopTimer(){ if(timer){ clearInterval(timer); timer=null; } }

document.getElementById('pause').addEventListener('change', e => {
  if(e.target.checked) stopTimer(); else startTimer();
});

document.addEventListener('click', (e) => {
  const th = e.target.closest('.sortable'); if(!th) return;
  const table = th.closest('table').id;
  const field = th.dataset.field;
  if(table === 'tblExec'){
    sortExec.dir = (sortExec.field === field && sortExec.dir === 'asc') ? 'desc' : 'asc';
    sortExec.field = field;
  }else{
    sortJobs.dir = (sortJobs.field === field && sortJobs.dir === 'asc') ? 'desc' : 'asc';
    sortJobs.field = field;
  }
  load();
});

function applyFilter(rows, search){
  if(!search) return rows;
  const q = search.toLowerCase();
  return rows.filter(j => {
    const id = (p(j,'id','Id')||'').toLowerCase();
    const key = (p(j,'concurrencyKey','ConcurrencyKey')||'').toLowerCase();
    const cron = (p(j,'cronExpression','CronExpression')||'').toLowerCase();
    return id.includes(q) || key.includes(q) || cron.includes(q);
  });
}

async function load(){
  try{
    const r = await fetch('/api/health', { cache:'no-store' });
    const d = await r.json();
    const now = new Date(p(d,'nowUtc','NowUtc'));
    document.getElementById('status').textContent = `Now: ${now.toISOString()}  |  events: ${p(d,'recentCount','RecentCount')}`;

    const jobs = (d.scheduled || d.Scheduled || []).slice();
    const exec = (d.recent || d.Recent || []).slice();

    // KPIs
    const k = computeKpis(exec);
    document.getElementById('k_total').textContent = k.total;
    document.getElementById('k_ok').textContent = k.ok;
    document.getElementById('k_fail').textContent = k.fail;
    document.getElementById('k_avg').textContent = fmtMs(k.avg);

    // filter
    const search = document.getElementById('search').value.trim();
    const jobsFiltered = applyFilter(jobs, search);

    // sort jobs
    jobsFiltered.sort((a,b) => {
      const va = (p(a, sortJobs.field, sortJobs.field.charAt(0).toUpperCase()+sortJobs.field.slice(1))||'').toString();
      const vb = (p(b, sortJobs.field, sortJobs.field.charAt(0).toUpperCase()+sortJobs.field.slice(1))||'').toString();
      return sortJobs.dir === 'asc' ? va.localeCompare(vb) : vb.localeCompare(va);
    });

    // render jobs
    const jb = document.querySelector('#tblJobs tbody');
    jb.innerHTML = '';
    jobsFiltered.forEach(j => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="mono">${p(j,'id','Id')}</td>
        <td class="mono">${p(j,'cronExpression','CronExpression')}</td>
        <td>${p(j,'timeZone','TimeZone')}</td>
        <td class="mono">${p(j,'concurrencyKey','ConcurrencyKey') || ''}</td>
        <td>${p(j,'allowParallelRuns','AllowParallelRuns') ? 'Yes' : 'No'}</td>
        <td>${p(j,'maxRuntimeMinutes','MaxRuntimeMinutes') ?? ''}</td>
        <td class="mono">${p(j,'nextRunUtc','NextRunUtc') || ''}</td>
        <td>${p(j,'enabled','Enabled') ? '<span class="chip">ON</span>' : '<span class="chip">OFF</span>'}</td>`;
      jb.appendChild(tr);
    });

    // sort executions
    exec.sort((a,b) => {
      const fa = p(a, sortExec.field, sortExec.field.charAt(0).toUpperCase()+sortExec.field.slice(1));
      const fb = p(b, sortExec.field, sortExec.field.charAt(0).toUpperCase()+sortExec.field.slice(1));
      let va = fa, vb = fb;
      if(sortExec.field === 'endUtc' || sortExec.field === 'startUtc' || sortExec.field === 'NextRunUtc'){
        va = Date.parse(fa || 0) || 0; vb = Date.parse(fb || 0) || 0;
      }
      if(sortExec.field === 'durationMs'){ va = Number(fa)||0; vb = Number(fb)||0; }
      return (sortExec.dir === 'asc') ? (va - vb) : (vb - va);
    });

    // render executions
    const eb = document.querySelector('#tblExec tbody');
    eb.innerHTML = '';
    exec.forEach(ev => {
      const ok = !!p(ev,'success','Success');
      const skipped = !!p(ev,'skippedDueToConflict','SkippedDueToConflict');
      const status = skipped ? '<span class="warn">Skipped (lock)</span>' :
                     (ok ? '<span class="ok">OK</span>' : '<span class="err">FAIL</span>');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="mono">${p(ev,'endUtc','EndUtc') || ''}</td>
        <td class="mono">${p(ev,'commandId','CommandId') || ''}</td>
        <td>${p(ev,'exitCode','ExitCode') ?? ''}</td>
        <td>${fmtMs(p(ev,'durationMs','DurationMs'))}</td>
        <td>${status}</td>
        <td class="mono">${(p(ev,'error','Error') || '').slice(0,300)}</td>`;
      eb.appendChild(tr);
    });

    const toggle = document.getElementById('toggleRaw');
    const pre = document.getElementById('json');
    const details = document.getElementById('raw');
    if (toggle && pre && details) {
      if (toggle.checked) { pre.textContent = JSON.stringify(d, null, 2); details.open = true; }
      else { pre.textContent = ''; details.open = false; }
    }
  }catch(e){
    document.getElementById('status').textContent = 'Error loading /api/health';
  }
}

document.getElementById('search').addEventListener('input', () => load());
load(); startTimer();
    </script>
</body>
</html>
